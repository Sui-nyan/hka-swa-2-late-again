generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

model Station {
    eva   Int      @id
    name  String
    ds100 String   @unique // Station Code
    meta  String[] // Eva station numbers of connected stations
    p     String[] // platforms
    isDb  Boolean  @default(false)

    plans Plan[]
}

model Plan {
    id             Int      @id @default(autoincrement()) // "RequestId"
    eva            Int
    targetDatetime String
    createdAt      DateTime @default(now())

    stops   Stop[]
    station Station @relation(references: [eva], fields: [eva])

    @@unique([eva, targetDatetime])
}

model Stop {
    id   String     @id
    ar   Arrival?
    dp   Departure?
    tl   TrainInfo? @relation(fields: [trainInfoId], references: [id])
    plan Plan       @relation(fields: [planId], references: [id])

    trainInfoId Int
    planId      Int
}

model Arrival {
    pt   DateTime // planned time
    ppth String[] // planned path

    // Backlinks
    stop   Stop   @relation(fields: [stopId], references: [id])
    stopId String @unique
}

model Departure {
    pt   DateTime // planned time
    ppth String[] // planned path

    // Backlinks
    stop   Stop   @relation(fields: [stopId], references: [id])
    stopId String @unique
}

model TrainInfo {
    id Int @id @default(autoincrement())

    c String?
    n String?
    f String? // FilterFlag
    o String? // Owner
    t String? // triptype

    stops Stop[]
}

// // ============================================================================
// // TIMETABLE MODELS (from DB_API schema) Changes
// // ============================================================================

model StopChange {
    id          Int    @id @default(autoincrement())
    // reference Stop? @relation(fields: [referenceId], references: [id])
    referenceId String // Sometimes does not exist yet

    createdAt DateTime @default(now())

    // relations (optional 1:1)
    arrival   ArrivalChange?
    departure DepartureChange?

    // optional FK fields
}

model ArrivalChange {
    id  Int       @id @default(autoincrement())
    ct  DateTime? // Changed time
    clt DateTime? // Cancellation time
    cs  String? // Change Status

    stopChange   StopChange @relation(fields: [stopChangeId], references: [id])
    stopChangeId Int        @unique
}

model DepartureChange {
    id  Int       @id @default(autoincrement())
    ct  DateTime? // Changed time
    clt DateTime? // Cancellation time
    cs  String? // Change Status

    stopChange   StopChange @relation(fields: [stopChangeId], references: [id])
    stopChangeId Int        @unique
}

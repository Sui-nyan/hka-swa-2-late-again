generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Station {
    // def better_get_station(pattern: str) -> list:
    //     """Returns a list of stations matching the pattern."""
    //     res = get_station(pattern)
    //     res.raise_for_status()
    //     soup = soupify_xml(res.text)
    //     stations = soup.find_all("station")
    //     return [
    //         {
    //             "name": s.get("name"),
    //             "p (platforms)": s.get("p").split("|") if s.get("p") else [], # platforms
    //             "eva (EVA station number)": s.get("eva"), # EVA station number
    //             "ds100 (Station code)": s.get("ds100"), # Station code
    //             "meta (Meta information)": s.get("meta"), # Meta information
    //             "db (isDb?)": s.get("db"), # isDb?
    //         }
    //         for s in stations
    //     ]
    eva       Int      @id
    name      String
    ds100     String   @unique // Station Code
    meta      String[] // Eva station numbers of connected stations
    p         String[] // platforms
    isDb      Boolean  @default(false)
    platforms String[]
}

model Plan {
    id        Int      @id // "RequestId"
    stops     Stop[]
    createdAt DateTime @default(now())
}

model Stop {
    // def parse_stop(s):
    //     ar = parse_ar(s.ar) if s.ar else None # arrival
    //     dp = parse_dp(s.dp) if s.dp else None # departure
    //     tl = parse_tl(s.tl) if s.tl else None # track/ platform
    //     return {
    //         "id": s.get("id"),
    //         "ar (arrival)": ar,
    //         "dp (departure)": dp,
    //         "tl (trainInfoTuple)": tl
    //     }
    id          Int       @id
    ar          Arrival
    dp          Departure
    tl          TrainInfo @relation(fields: [trainInfoId], references: [id])
    plan        Plan      @relation(fields: [planId], references: [id])
    trainInfoId Int
    planId      Int
}

model Arrival {
    //     def parse_ar(ar: BeautifulSoup):
    //         return {
    //             "pp (plannedPlatform)": ar.get("pp"), # planned platform
    //             "ppth (plannedPath)": ar.get("ppth").split('|'), # planned path
    //             "pt (plannedTime)": ar.get("pt"), # planned time
    //             "l (line)": ar.get("l"), # line
    //         }
    pt DateTime // planned time
    l  Int // line

    stop   Stop @relation(fields: [stopId], references: [id])
    stopId Int
}

model Departure {
    //     def parse_dp(dp: BeautifulSoup):
    //         return {
    //             "pp (plannedPlatform)": dp.get("pp"), # planned platform
    //             "ppth (plannedPath)": dp.get("ppth").split('|'), # planned path
    //             "pt (plannedTime)": dp.get("pt"), # planned time
    //             "l (line)": dp.get("l"), # line
    //         }
    pp   String
    ppth String[]
    pt   DateTime
    l    String

    stop   Stop @relation(fields: [stopId], references: [id])
    stopId Int
}

model TrainInfo {
    // def parse_tl(tl: BeautifulSoup):
    //     return {
    //         "c (category)": tl.get("c"), # e.g. ICE, RE
    //         "n (trainNumber)": tl.get("n"), # train number
    //         "f (filterFlag)": tl.get("f"), # filter flag
    //         "o (owner)": tl.get("o"), # owner
    //         "t (tripType)": tl.get("t"), # trip type {p,e,z,s,h,n}
    //     }

    id Int @id

    c String
    n String
    f String // FilterFlag
    o String // Owner
    t String // triptype

    category Category @relation(fields: [c], references: [c])

    stop   Stop @relation(fields: [stopId], references: [id])
    stopId Int
}

model Category {
    c String @unique

    trainInfos TrainInfo[]
}

// ============================================================================
// TIMETABLE MODELS (from DB_API schema)
// ============================================================================

model Timetable {
    id        String          @id @default(cuid())
    eva       BigInt
    station   String
    messages  Message[]
    stops     TimetableStop[]
    createdAt DateTime        @default(now())
}

model TimetableStop {
    id          String    @id
    eva         BigInt
    timetable   Timetable @relation(fields: [timetableId], references: [id])
    timetableId String
    arrival     Event?    @relation("arrival")
    departure   Event?    @relation("departure")

    connections             Connection[]
    messages                Message[]
    historicDelays          HistoricDelay[]
    historicPlatformChanges HistoricPlatformChange[]
    reference               Reference?
    referenceTripRelations  ReferenceTripRelation[]
    tripLabel               TripLabel?

    @@unique([id, timetableId])
}

model Event {
    id              String         @id @default(cuid())
    cde             String? // Changed distant endpoint
    clt             String? // Cancellation time (YYMMddHHmm format)
    cp              String? // Changed platform
    cpth            String? // Changed path
    cs              String? // Event status (p=PLANNED, a=ADDED, c=CANCELLED)
    ct              String? // Changed time (YYMMddHHmm format)
    dc              Int? // Distant change
    hi              Int? // Hidden flag
    l               String? // Line
    pde             String? // Planned distant endpoint
    pp              String? // Planned platform
    ppth            String? // Planned path
    ps              String? // Planned status
    pt              String? // Planned time (YYMMddHHmm format)
    tra             String? // Transition trip id
    wings           String? // Wing trip ids
    messages        Message[]
    arrivalStop     TimetableStop? @relation("arrival", fields: [arrivalStopId], references: [id])
    arrivalStopId   String?        @unique
    departureStop   TimetableStop? @relation("departure", fields: [departureStopId], references: [id])
    departureStopId String?        @unique
}

model Message {
    id          String               @id @default(cuid())
    c           Int? // Code
    cat         String? // Category
    del         Int? // Deleted
    dm          DistributorMessage[]
    ec          String? // External category
    elnk        String? // External link
    ext         String? // External text
    from        String? // Valid from (YYMMddHHmm format)
    int         String? // Internal text
    o           String? // Owner
    pr          String? // Priority (1=HIGH, 2=MEDIUM, 3=LOW, 4=DONE)
    t           String // Message type (h=HIM, q=QUALITY_CHANGE, f=FREE, d=CAUSE_OF_DELAY, i=IBIS, u=UNASSIGNED_IBIS, r=DISRUPTION, c=CONNECTION)
    tl          TripLabel[]
    to          String? // Valid to (YYMMddHHmm format)
    ts          String // Timestamp (YYMMddHHmm format)
    timetable   Timetable            @relation(fields: [timetableId], references: [id])
    timetableId String
    stop        TimetableStop?       @relation(fields: [stopId], references: [id])
    stopId      String?
    event       Event?               @relation(fields: [eventId], references: [id])
    eventId     String?
}

model DistributorMessage {
    id        String  @id @default(cuid())
    int       String? // Internal text
    n         String? // Distributor name
    t         String? // Distributor type (s=CITY, r=REGION, f=LONG_DISTANCE, x=OTHER)
    ts        String? // Timestamp (YYMMddHHmm format)
    message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
    messageId String
}

model TripLabel {
    id          String         @id @default(cuid())
    c           String // Category (e.g. ICE, RE)
    f           String? // Filter flags
    n           String // Train number
    o           String // Owner
    t           String? // Trip type (p, e, z, s, h, n)
    message     Message?       @relation(fields: [messageId], references: [id])
    messageId   String?
    stop        TimetableStop? @relation(fields: [stopId], references: [id])
    stopId      String?
    references  Reference[]
    reference   Reference?     @relation(fields: [referenceId], references: [id])
    referenceId String?
}

model Connection {
    id              String         @id @default(cuid())
    cs              String // Connection status (w=WAITING, n=TRANSITION, a=ALTERNATIVE)
    eva             BigInt
    ts              String // Timestamp (YYMMddHHmm format)
    stop            TimetableStop  @relation(fields: [stopId], references: [id])
    stopId          String
    s               TimetableStop? @relation(fields: [timetableStopId], references: [id]) // Reference to connected stop
    ref             TimetableStop? @relation(fields: [timetableStopId], references: [id]) // Reference stop
    timetableStopId String?
}

model HistoricDelay {
    id     String        @id @default(cuid())
    ar     String? // Arrival event (YYMMddHHmm format)
    cod    String? // Detailed description of delay cause
    dp     String? // Departure event (YYMMddHHmm format)
    src    String? // Delay source (L, NA, NM, V, IA, IM, A)
    ts     String // Timestamp (YYMMddHHmm format)
    stop   TimetableStop @relation(fields: [stopId], references: [id])
    stopId String
}

model HistoricPlatformChange {
    id     String        @id @default(cuid())
    ar     String? // Arrival platform
    cot    String? // Detailed cause of track change
    dp     String? // Departure platform
    ts     String // Timestamp (YYMMddHHmm format)
    stop   TimetableStop @relation(fields: [stopId], references: [id])
    stopId String
}

model Reference {
    id          String        @id @default(cuid())
    tl          TripLabel?    @relation(fields: [tripLabelId], references: [id]) // Trip label
    rt          TripLabel[] // Reference trip labels
    stop        TimetableStop @relation(fields: [stopId], references: [id])
    stopId      String        @unique
    tripLabelId String?
}

model ReferenceTripRelation {
    id              String        @id @default(cuid())
    rt              ReferenceTrip @relation(fields: [referenceTripId], references: [id])
    rts             String // Reference trip status (b=BEFORE, e=END, c=BETWEEN, s=START, a=AFTER)
    stop            TimetableStop @relation(fields: [stopId], references: [id])
    stopId          String
    referenceTripId String
}

model ReferenceTrip {
    id     String             @id @default(cuid())
    c      Boolean // Cancellation flag
    tripId String // Id
    rtl    ReferenceTripLabel @relation(fields: [referenceTripLabelId], references: [id])
    ea     ReferenceTripStop  @relation(fields: [referenceTripStopSdId], references: [id])
    sd     ReferenceTripStop  @relation(fields: [referenceTripStopEaId], references: [id])

    referenceTripStopSdId String
    referenceTripStopEaId String

    referenceTripLabelId   String
    referenceTripRelations ReferenceTripRelation[]
}

model ReferenceTripStop {
    id             String          @id @default(cuid())
    eva            BigInt
    i              Int // Index
    n              String // Name
    pt             String // Planned time (YYMMddHHmm format)
    referenceTrips ReferenceTrip[]
}

model ReferenceTripLabel {
    id             String          @id @default(cuid())
    c              String // Category
    n              String // Train number
    referenceTrips ReferenceTrip[]
}
